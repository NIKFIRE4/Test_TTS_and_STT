# Streaming TTS + Offline STT Pipeline

–ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –¥–ª—è —Å–∏–Ω—Ç–µ–∑–∞ –∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏ —Å –ø–æ—Ç–æ–∫–æ–≤–æ–π –ø–µ—Ä–µ–¥–∞—á–µ–π –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–µ–∫—Ç —Ä–µ–∞–ª–∏–∑—É–µ—Ç —Ç—Ä–∏ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã—Ö —Å–µ—Ä–≤–∏—Å–∞: TTS (Text-to-Speech), ASR (Automatic Speech Recognition) –∏ Gateway –¥–ª—è –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤.

## üéØ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- **–ü–æ—Ç–æ–∫–æ–≤—ã–π —Å–∏–Ω—Ç–µ–∑ —Ä–µ—á–∏ (TTS)** ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∞—É–¥–∏–æ —Å –ø–µ—Ä–µ–¥–∞—á–µ–π –¥–∞–Ω–Ω—ã—Ö –ø–æ –º–µ—Ä–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ (chunked streaming)
- **–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏ (STT/ASR)** ‚Äî —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—è –∞—É–¥–∏–æ—Ñ–∞–π–ª–æ–≤ –≤ —Ç–µ–∫—Å—Ç —Å –≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –º–µ—Ç–∫–∞–º–∏
- **Echo pipeline** ‚Äî –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª: –∞—É–¥–∏–æ ‚Üí —Ç–µ–∫—Å—Ç ‚Üí —Å–∏–Ω—Ç–µ–∑ ‚Üí –∞—É–¥–∏–æ
- **HTTP API** ‚Äî –≥–∏–±–∫–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- **Docker Compose** ‚Äî –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —Å –µ–¥–∏–Ω–æ–π —Å–µ—Ç—å—é –∏ –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º –º–æ–¥–µ–ª–µ–π

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Client  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ
     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ    Gateway      ‚îÇ :8000
‚îÇ  (Orchestrator) ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ        ‚îÇ
     ‚ñº        ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   TTS   ‚îÇ ‚îÇ   ASR   ‚îÇ
‚îÇ :8082   ‚îÇ ‚îÇ :8081   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

- **TTS Service** ‚Äî —Å–∏–Ω—Ç–µ–∑ —Ä–µ—á–∏ –Ω–∞ –±–∞–∑–µ Silero TTS (PyTorch)
- **ASR Service** ‚Äî —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏ —á–µ—Ä–µ–∑ Vosk (–∞–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫)
- **Gateway** ‚Äî –µ–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞, –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∫–æ–º–ø–æ–∑–∏—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Docker Desktop –∏–ª–∏ Docker Engine + Docker Compose
- 4+ GB RAM (–¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏ —Ä–∞–±–æ—Ç—ã –º–æ–¥–µ–ª–µ–π)
- –î–æ—Å—Ç—É–ø –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É (–¥–ª—è –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–µ–π)

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –∑–∞–ø—É—Å–∫

1. **–ö–ª–æ–Ω–∏—Ä—É–π—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π**

```bash
git clone <repository-url>
cd streaming-tts-stt
```

2. **–°–æ–∑–¥–∞–π—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª .env**

–°–æ–¥–µ—Ä–∂–∏–º–æ–µ `.env`:
```env
ASR_MODEL_SIZE=base.en
# Maximum audio duration in seconds
MAX_AUDIO_DURATION=15
GATEWAY_PORT=8000
TTS_SERVICE_URL=http://tts:8082
ASR_SERVICE_URL=http://asr:8081
# Request timeout in seconds
REQUEST_TIMEOUT=60
```

3. **–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–∏—Å—ã**

```bash
docker-compose up --build
```

–ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ –ø—Ä–æ–∏–∑–æ–π–¥—ë—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–µ–π:
- Silero TTS (English v3) ‚Äî ~50 MB
- Vosk Small English ‚Äî ~40 MB


## üì° API Documentation

### 1. TTS ‚Äî –°–∏–Ω—Ç–µ–∑ —Ä–µ—á–∏ (—á–µ—Ä–µ–∑ Gateway)

#### HTTP POST `/api/tts`

–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∞—É–¥–∏–æ –∏–∑ —Ç–µ–∫—Å—Ç–∞ —Å –ø–æ—Ç–æ–∫–æ–≤–æ–π –æ—Ç–¥–∞—á–µ–π PCM –¥–∞–Ω–Ω—ã—Ö.

**–ó–∞–ø—Ä–æ—Å:**
```bash
curl -X POST http://localhost:8000/api/tts \
  -H "Content-Type: application/json" \
  -d '{"text": "Hello world"}' \
  --output speech.pcm
```

**–û—Ç–≤–µ—Ç:**
- `Content-Type: application/octet-stream`
- –§–æ—Ä–º–∞—Ç: PCM s16le, 16kHz, mono
- –ó–∞–≥–æ–ª–æ–≤–∫–∏: `X-Audio-Format`, `X-Sample-Rate`, `X-Channels`

#### –ü—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –∫ TTS (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

```bash
# PCM —Ñ–æ—Ä–º–∞—Ç
curl -X POST http://localhost:8082/api/tts \
  -H "Content-Type: application/json" \
  -d '{"text": "Hello world"}' \
  --output speech.pcm

# WAV —Ñ–æ—Ä–º–∞—Ç (–º–æ–∂–Ω–æ —Å—Ä–∞–∑—É –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏)
curl -X POST http://localhost:8082/api/tts/wav \
  -H "Content-Type: application/json" \
  -d '{"text": "Hello world"}' \
  --output speech.wav
```

### 2. ASR ‚Äî –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏

#### HTTP POST `/api/stt/bytes`

–¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä—É–µ—Ç —Å—ã—Ä—ã–µ PCM –±–∞–π—Ç—ã –≤ —Ç–µ–∫—Å—Ç.

**–ó–∞–ø—Ä–æ—Å:**
```bash
curl -X POST "http://localhost:8081/api/stt/bytes?sr=16000&ch=1&fmt=s16le" \
  -H "Content-Type: application/octet-stream" \
  --data-binary @audio.pcm
```

**Query –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `sr` ‚Äî sample rate (8000, 16000, 22050, 44100, 48000)
- `ch` ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞–Ω–∞–ª–æ–≤ (1 –∏–ª–∏ 2)
- `fmt` ‚Äî —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö (s16le, s32le, float32)
- `lang` ‚Äî —è–∑—ã–∫ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é "en")

**–û—Ç–≤–µ—Ç:**
```json
{
  "text": "hello world this is a test",
  "segments": [
    {"start_ms": 0, "end_ms": 500, "text": "hello"},
    {"start_ms": 500, "end_ms": 1200, "text": "world"}
  ],
  "language": "en",
  "duration_seconds": 3.5
}
```

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:**
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∞—É–¥–∏–æ: 15 —Å–µ–∫—É–Ω–¥
- –¢–æ–ª—å–∫–æ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫

### 3. Echo Pipeline ‚Äî ASR ‚Üí TTS

#### HTTP POST `/api/echo-bytes`

–ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª: —Ä–∞—Å–ø–æ–∑–Ω–∞—ë—Ç —Ä–µ—á—å –∏–∑ –∞—É–¥–∏–æ –∏ —Å–∏–Ω—Ç–µ–∑–∏—Ä—É–µ—Ç –µ—ë –æ–±—Ä–∞—Ç–Ω–æ.

**–ó–∞–ø—Ä–æ—Å:**
```bash
curl -X POST "http://localhost:8000/api/echo-bytes?sr=16000&ch=1&fmt=s16le" \
  -H "Content-Type: application/octet-stream" \
  --data-binary @input.pcm \
  --output output.pcm
```

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ü–æ–ª—É—á–∞–µ—Ç PCM –±–∞–π—Ç—ã –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞
2. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ ASR –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
3. –ü–æ–ª—É—á–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –ø–µ—Ä–µ–¥–∞—ë—Ç –≤ TTS
4. –°—Ç—Ä–∏–º–∏—Ç —Å–∏–Ω—Ç–µ–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∞—É–¥–∏–æ –æ–±—Ä–∞—Ç–Ω–æ –∫–ª–∏–µ–Ω—Ç—É

**–û—Ç–≤–µ—Ç:**
- `Content-Type: application/octet-stream`
- –ó–∞–≥–æ–ª–æ–≤–æ–∫ `X-Recognized-Text` —Å–æ–¥–µ—Ä–∂–∏—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
- –¢–µ–ª–æ: PCM –ø–æ—Ç–æ–∫ (16kHz, mono, s16le)

## üß™ –¢–µ—Å—Ç–æ–≤—ã–µ –∫–ª–∏–µ–Ω—Ç—ã

–í –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ `client/` –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≥–æ—Ç–æ–≤—ã–µ Python —Å–∫—Ä–∏–ø—Ç—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.

### 1. TTS –∫–ª–∏–µ–Ω—Ç

–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–µ–∫—Å—Ç –Ω–∞ —Å–∏–Ω—Ç–µ–∑ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ WAV:

```bash
cd client
python stream_tts.py
```

–†–µ–∑—É–ª—å—Ç–∞—Ç:
```
–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ http://localhost:8000/api/tts...
–¢–µ–∫—Å—Ç: Hello world, this is a streaming TTS test.

–ü–æ–ª—É—á–µ–Ω–∏–µ –∞—É–¥–∏–æ-—á–∞–Ω–∫–æ–≤:
–§—Ä–µ–π–º 1: 4096 –±–∞–π—Ç, –≤—Ä–µ–º—è: 1730000000.123
–§—Ä–µ–π–º 2: 4096 –±–∞–π—Ç, –≤—Ä–µ–º—è: 1730000000.145
...

‚úì –ê—É–¥–∏–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ input.wav
–í—Å–µ–≥–æ —Ñ—Ä–µ–π–º–æ–≤: 42, —Ä–∞–∑–º–µ—Ä: 168960 –±–∞–π—Ç
```

### 2. Echo –∫–ª–∏–µ–Ω—Ç

–ß–∏—Ç–∞–µ—Ç WAV, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –∏ —Å–∏–Ω—Ç–µ–∑, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç:

```bash
cd client
python echo_bytes.py
```

–†–µ–∑—É–ª—å—Ç–∞—Ç:
```
–í—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª: input.wav
–ü–∞—Ä–∞–º–µ—Ç—Ä—ã: 1ch, 16000Hz, 16bit
–†–∞–∑–º–µ—Ä PCM: 168960 –±–∞–π—Ç

–û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ http://localhost:8000/api/echo-bytes...

–ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞:
üìù –†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç: hello world this is a streaming tts test

–§—Ä–µ–π–º 1: 4096 –±–∞–π—Ç, –≤—Ä–µ–º—è: 1730000001.234
–§—Ä–µ–π–º 2: 4096 –±–∞–π—Ç, –≤—Ä–µ–º—è: 1730000001.256
...

‚úì –ê—É–¥–∏–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ out_echo.wav
–í—Å–µ–≥–æ —Ñ—Ä–µ–π–º–æ–≤: 38, —Ä–∞–∑–º–µ—Ä: 155648 –±–∞–π—Ç
```

### Docker volumes

–ü—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–µ —Ç–æ–º–∞ –¥–ª—è –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è:

- `models_tts` ‚Äî –≤–µ—Å–∞ Silero TTS –º–æ–¥–µ–ª–∏
- `models_asr` ‚Äî –≤–µ—Å–∞ Vosk –º–æ–¥–µ–ª–∏
- `speech_logs` ‚Äî –ª–æ–≥–∏ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

–ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤:
```bash
# –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã
docker-compose logs -f

# –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Å–µ—Ä–≤–∏—Å
docker-compose logs -f gateway
docker-compose logs -f tts
docker-compose logs -f asr
```



## üß∞ –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

### Backend
- **Python 3.10** ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π —è–∑—ã–∫ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- **FastAPI** ‚Äî –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –≤–µ–±-—Ñ—Ä–µ–π–º–≤–æ—Ä–∫
- **Uvicorn** ‚Äî ASGI —Å–µ—Ä–≤–µ—Ä

### ML Models
- **Silero TTS** (PyTorch) ‚Äî –±—ã—Å—Ç—Ä—ã–π —Ä—É—Å—Å–∫–æ-–∞–Ω–≥–ª–∏–π—Å–∫–∏–π —Å–∏–Ω—Ç–µ–∑ —Ä–µ—á–∏
- **Vosk** ‚Äî –ª–µ–≥–∫–æ–≤–µ—Å–Ω–æ–µ –æ—Ñ—Ñ–ª–∞–π–Ω —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏

### Infrastructure
- **Docker & Docker Compose** ‚Äî –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è –∏ –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è
- **httpx** ‚Äî –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π HTTP –∫–ª–∏–µ–Ω—Ç –¥–ª—è –º–µ–∂—Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è


**–°–æ–∑–¥–∞–Ω–æ —Å ‚ù§Ô∏è –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–∞–≤—ã–∫–æ–≤ —Ä–∞–±–æ—Ç—ã —Å ML, Docker –∏ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π**
